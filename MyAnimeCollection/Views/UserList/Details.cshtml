@model Models.UserListModel

@{
    ViewData["Title"] = "Detalhes da Lista";
    var userId = ViewBag.AuthenticatedUserId as int?;
}

<!-- UserList Details -->
<h1><strong>Nome: </strong>@Model.Name</h1>
<p><strong>Descrição: </strong>@Model.Description</p>
<p><strong>Criada por: </strong>@ViewBag.CreatorName</p>

<!-- Average rating -->
<h5>Média das Avaliações:</h5>
<div class="average-rating" style="font-size: 1.5rem; color: gold;">
    @for (int i = 1; i <= 5; i++)
    {
        @(i <= Math.Round(ViewBag.AverageRating) ? "★" : "☆")
    }
    <span style="color: black;">(@ViewBag.AverageRating.ToString("0.0") estrelas)</span>
</div>

<!-- Rating form -->
<h5>Avaliar esta Lista:</h5>
<form asp-action="SubmitListRating" method="post">
    <input type="hidden" name="listId" value="@Model.UserListId" />
    <div class="rating" style="font-size: 1.5rem; color: gold;">
        @for (int i = 1; i <= 5; i++)
        {
            <input type="radio" id="star-@i" name="stars" value="@i" style="display: none;" />
            <label for="star-@i" class="star" data-value="@i" style="cursor: pointer;">☆</label>
        }
    </div>
    <button type="submit" class="btn btn-primary mt-2">Enviar Avaliação</button>
</form>

<div id="listDetails" data-list-id="@Model.UserListId"></div>

@if (ViewBag.AnimesList == null || !((List<Anime>)ViewBag.AnimesList).Any())
{
    <p>Não existem animes nesta lista.</p>
}
else
{
    <div class="row">
        @foreach (var anime in (List<Anime>)ViewBag.AnimesList)
        {
            <div class="col-md-3">
                <div class="card">
                    <a href="@Url.Action("Details", "Anime", new { id = anime.AnimeId })">
                        <img src="@anime.ImageURL" class="card-img-top" alt="@anime.Title" />
                    </a>

                    <!-- Dropdown to add an anime to a list -->
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="@Url.Action("Details", "Anime", new { id = anime.AnimeId })">
                                @anime.Title
                            </a>
                        </h5>
                        @if (userId == Model.UserId)
                        {
                            <div>
                                <button class="btn btn-danger btn-sm remove-anime-btn" data-anime-id="@anime.AnimeId">
                                    -
                                </button>

                            </div>
                        }
                        <div class="dropdown mt-2">
                            <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                Opções
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <li>
                                    <a class="dropdown-item"
                                        href="@Url.Action("CreateUserList", "UserList", new { animeId = anime.AnimeId })">
                                        Criar Nova Lista
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showExistingListsModal(@anime.AnimeId)">
                                        Adicionar a Lista Existente
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- Modal to add an anime to an existing list -->
<div class="modal fade" id="existingListsModal" tabindex="-1" aria-labelledby="existingListsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="existingListsModalLabel">Adicionar a Lista Existente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addToExistingListForm">
                    <input type="hidden" id="animeIdInput" name="animeId" />
                    <div class="mb-3">
                        <label for="listSelect" class="form-label">Selecione uma Lista</label>
                        <select class="form-select" id="listSelect" name="listId">
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Script to show the modal and populate the select with the user's lists -->
<script>
    function showExistingListsModal(animeId) {
        $('#animeIdInput').val(animeId);

        $.ajax({
            url: '@Url.Action("GetUserLists", "UserList")',
            type: 'GET',
            success: function (data) {
                var listSelect = $('#listSelect');
                listSelect.empty();
                data.forEach(function (list) {
                    listSelect.append(new Option(list.name, list.userListId));
                });
                $('#existingListsModal').modal('show');
            },
            error: function () {
                alert('Erro ao carregar as listas do utilizador.');
            }
        });
    }
</script>

<!-- Script to remove an anime from a list -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const removeAnimeButtons = document.querySelectorAll('.remove-anime-btn');
        const listDetails = document.getElementById('listDetails');
        const listId = parseInt(listDetails?.dataset?.listId);

        if (!listId || listId <= 0) {
            console.error("ID da lista inválido. Verifique o carregamento da página.");
            return;
        }

        removeAnimeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const animeId = this.dataset.animeId;

                if (!animeId) {
                    console.error("ID do anime não encontrado.");
                    return;
                }

                if (confirm("Tem certeza de que deseja remover este anime da lista?")) {
                    console.log("Removendo anime:", animeId, "da lista:", listId);
                    fetch('/UserList/RemoveAnimeFromList', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ animeId, listId }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            if (data.success) {
                                location.reload();
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao remover o anime:", error);
                            alert("Ocorreu um erro ao tentar remover o anime da lista.");
                        });
                }
            });
        });
    });

</script>


<!-- Colors for the stars -->
<style>
    .star {
        font-size: 1.5rem;
        color: gray;
    }

    .star.filled {
        color: gold;
    }
</style>

<!-- Script to update the stars -->
<script>
    document.querySelectorAll('.rating').forEach(rating => {
        const stars = rating.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', function () {
                const selectedValue = parseInt(this.getAttribute('data-value'));
                stars.forEach((s, index) => {
                    if (index < selectedValue) {
                        s.classList.add('filled');
                        s.textContent = '★';
                    } else {
                        s.classList.remove('filled');
                        s.textContent = '☆';
                    }
                });
            });
        });
    });
</script>
